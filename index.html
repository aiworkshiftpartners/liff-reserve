<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>無料相談の予約（LINE限定）</title>
  <style>
    :root{
      --brand:#1a2e44;         /* ボタンと同じ色（○の色もこれ） */
      --grid-border:#e5e7eb;
      --muted:#666;
      --gray:#f2f4f7;
    }
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;background:#fafafa;color:#111;line-height:1.8}
    .wrap{min-height:100%;display:grid;place-items:start center;padding:16px}
    .card{width:100%;max-width:820px;background:#fff;border:1px solid var(--grid-border);border-radius:14px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    h1{margin:0 0 6px;font-weight:800;font-size:clamp(22px,4.5vw,28px)}
    .help{font-size:12px;color:var(--muted);margin:0 0 10px}

    .field{width:100%;padding:12px;border:1px solid #d1d5db;border-radius:10px;font-size:15px;background:#fafafa;margin:4px 0 10px}

    /* week nav */
    .weekbar{display:flex;align-items:center;gap:8px;justify-content:center;margin:8px 0 10px}
    .weekbtn{border:1px solid var(--grid-border);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
    .weekbtn[disabled]{opacity:.5;cursor:not-allowed}
    .weektitle{font-weight:700}

    /* calendar grid */
    .cal{border:1px solid var(--grid-border);border-radius:10px}
    .grid{display:grid;grid-template-columns: 54px repeat(7,1fr)}
    .cell{border-right:1px solid #eee;border-bottom:1px solid #eee;padding:6px;display:flex;align-items:center;justify-content:center}
    /* 置き換え or 追記 */

/* ヘッダ */
.th{background:#f5f7fa;font-weight:700}
.th2{background:#f5f7fa;font-weight:700} /* ← 日付行も同じ背景に */

.ok{
  cursor:pointer;border-radius:10px;border:2px solid var(--brand);background:#fff;
  width:100%;max-width:54px;height:38px;display:flex;align-items:center;justify-content:center;
  transition:box-shadow .15s,border-color .15s, background .15s, color .15s, transform .05s;
}
.ok .mark{font-size:22px;line-height:1;color:var(--brand)}
.ok:hover{box-shadow:0 2px 8px rgba(0,0,0,.08)}
/* クリックで“色反転＋拡大＋太枠”に */
.ok.selected{
  background:var(--brand);
  border-color:var(--brand);
  box-shadow:0 0 0 3px rgba(26,46,68,.18);
  transform:scale(1.06);
}
.ok.selected .mark{color:#fff}

/* スマホでも視認性を確保 */
@media (max-width: 480px){
  .ok,.ngbox{max-width:44px;height:34px}
  .ok .mark{font-size:20px}
  .ok.selected{transform:scale(1.04)}
}
    .dow{font-size:12px;color:#444}
    .date{font-size:13px}
    .sat .dow,.sat .date{color:#2563eb} /* 土=青 */
    .sun .dow,.sun .date{color:#ef4444} /* 日=赤   */

    .timecell{background:#fafafa;font-size:12px;font-weight:700}

    /* ボタン（○のみ大きく表示、時間ラベルは出さない） */
    .ok{cursor:pointer;border-radius:10px;border:2px solid var(--brand);background:#fff;width:100%;max-width:54px;height:38px;
        display:flex;align-items:center;justify-content:center;transition:box-shadow .15s,border-color .15s}
    .ok .mark{font-size:22px;line-height:1;color:var(--brand)}
    .ok:hover{box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .ok.selected{box-shadow:0 0 0 3px rgba(26,46,68,.18)}

    /* ×はクリック不可の灰色ボックス */
    .ngbox{width:100%;max-width:54px;height:38px;border-radius:10px;background:var(--gray);color:#9aa3af;
           display:flex;align-items:center;justify-content:center;font-size:20px;user-select:none}

    .confirmbar{display:flex;gap:10px;margin-top:12px}
    #confirmBtn{flex:1;padding:12px;border:none;border-radius:10px;background:var(--brand);color:#fff;font-size:15px;font-weight:800;cursor:pointer}
    #confirmBtn[disabled]{opacity:.55;cursor:not-allowed}

    /* スマホ最適化：横スクロールなしで収まるよう縮小 */
    @media (max-width: 480px){
      .grid{grid-template-columns: 44px repeat(7,1fr)}
      .cell{padding:4px}
      .ok,.ngbox{max-width:44px;height:34px}
      .ok .mark{font-size:20px}
      .timecell{font-size:11px}
      .date{font-size:12px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>無料相談予約フォーム</h1>
      <p class="help">名前と予約日時を選択し「この日時で予約」をクリック。表示は<strong>今日から2週間</strong>のみです。</p>

      <label>お名前</label>
      <input id="name" type="text" class="field" readonly />

      <div class="weekbar">
        <button id="prevWeek" class="weekbtn" type="button">←</button>
        <div id="weekTitle" class="weektitle" aria-live="polite"></div>
        <button id="nextWeek" class="weekbtn" type="button">→</button>
      </div>

      <div class="cal">
        <div id="grid" class="grid"></div>
      </div>

      <div class="confirmbar">
        <button id="confirmBtn" type="button" disabled>この日時で予約</button>
      </div>

      <p id="toast" class="help" aria-live="polite"></p>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js" defer></script>
  <script>
  (function(){
    const LIFF_ID  = "2007979122-nWPjgJGA";       // あなたのLIFF
    const API_BASE = `${location.origin}/api`;

    // 2週間制限（今週=0 / 来週=1）
    const WEEK_MIN = 0, WEEK_MAX = 1;

    // 時間軸（8:00〜23:30・30分刻み）
    const TIMES=[]; for(let h=8; h<=21; h++){ TIMES.push(`${pad(h)}:00`); if(h!==21) TIMES.push(`${pad(h)}:30`); }

    let displayName="", lineUserId=null;
    let weekIndex=0, selectedIso=null, weekSlots=[];

    // utils
    function pad(n){return (n<10?'0':'')+n}
    function wdayJP(d){return ['日','月','火','水','木','金','土'][d]}
    function startOfWeek(d){ const x=new Date(d.getFullYear(),d.getMonth(),d.getDate()); x.setDate(x.getDate()-x.getDay()); x.setHours(0,0,0,0); return x; }
    function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function fmtMD(d){ return `${d.getMonth()+1}/${pad(d.getDate())}` }
    function hm(d){ return `${pad(d.getHours())}:${pad(d.getMinutes())}` }

    function setWeekTitle(){
      const base = addDays(new Date(), weekIndex*7);
      const ws = startOfWeek(base), we = addDays(ws,6);
      // 2週間レンジを文言で示す
      document.getElementById('weekTitle').textContent =
        `${fmtMD(ws)}（${wdayJP(ws.getDay())}） 〜 ${fmtMD(we)}（${wdayJP(we.getDay())}）`;
      document.getElementById('prevWeek').disabled = (weekIndex<=WEEK_MIN);
      document.getElementById('nextWeek').disabled = (weekIndex>=WEEK_MAX);
    }
    function toast(t){ document.getElementById('toast').textContent = t || '' }

    function renderGrid(){
      const grid = document.getElementById('grid');
      grid.innerHTML = '';

      // 表示レンジ：今日0:00〜14日後0:00（今日含む14日）
      const rangeStart = new Date(); rangeStart.setHours(0,0,0,0);
      const rangeEnd = new Date(rangeStart); rangeEnd.setDate(rangeEnd.getDate()+14);

      const base = addDays(new Date(), weekIndex*7);
      const ws = startOfWeek(base);
      const days = [];
      for(let i=0;i<7;i++){
        const d = addDays(ws,i);
        if(d>=rangeStart && d<rangeEnd) days.push(d); // レンジ外は列を作らない（非表示）
      }

      // 列数：時間列 + 表示する日数
      grid.style.gridTemplateColumns = `54px repeat(${days.length}, 1fr)`;

      // ===== 1行目：曜日 =====
      // 左上（空白）
      grid.appendChild(cell('cell th'));
      days.forEach(d=>{
        const c = cell('cell th ' + (d.getDay()===0?'sun':d.getDay()===6?'sat':'')); // 日赤・土青
        c.innerHTML = `<div class="dow">${wdayJP(d.getDay())}</div>`;
        grid.appendChild(c);
      });

      // ===== 2行目：日付 =====
      // 左端（空白）
      grid.appendChild(cell('cell th2'));
      days.forEach(d=>{
        const c = cell('cell th2 ' + (d.getDay()===0?'sun':d.getDay()===6?'sat':'')); // 日赤・土青
        c.innerHTML = `<div class="date">${fmtMD(d)}</div>`;
        grid.appendChild(c);
      });

      // スロットをMap化
      const slotMap = new Map();
      weekSlots.forEach(s=>{
        const dt = new Date(s.startIso);
        const key = `${dt.getFullYear()}-${dt.getMonth()+1}-${dt.getDate()}|${hm(dt)}`;
        slotMap.set(key, s.startIso);
      });

      const now = new Date(); now.setSeconds(0,0);

      // ===== 時間行（○/×） =====
      TIMES.forEach(time=>{
        // 時刻列
        const tcell = cell('cell timecell'); tcell.textContent = time; grid.appendChild(tcell);

        days.forEach(d=>{
          const k = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}|${time}`;
          const iso = slotMap.get(k);

          const c = cell('cell');
          if(iso){
            const isPast = new Date(iso) < now;
            const btn = document.createElement('button');
            btn.className = 'ok' + (isPast?' disabled':'');
            btn.type='button'; btn.dataset.iso = iso;
            btn.innerHTML = `<span class="mark">○</span>`;
            if(!isPast){
              btn.addEventListener('click', ()=>{
                document.querySelectorAll('.ok.selected').forEach(el=>el.classList.remove('selected'));
                btn.classList.add('selected');
                selectedIso = iso;
                document.getElementById('confirmBtn').disabled = !selectedIso;
              });
            }else{
              btn.disabled = true;
              btn.style.opacity = .5;
              btn.style.cursor = 'not-allowed';
            }
            c.appendChild(btn);
          }else{
            const ng = document.createElement('div');
            ng.className = 'ngbox';
            ng.textContent = '×';
            c.appendChild(ng);
          }
          grid.appendChild(c);
        });
      });
    }

    function cell(cls){ const d=document.createElement('div'); d.className=cls; return d; }

    async function fetchWeek(){
      setWeekTitle();
      selectedIso=null; document.getElementById('confirmBtn').disabled = true;
      const res = await fetch(`${API_BASE}/available?week=${weekIndex}`, { headers:{accept:'application/json'} });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const j = await res.json();
      weekSlots = j.slots || [];
      renderGrid();
    }

    // イベント
    document.getElementById('prevWeek').addEventListener('click', async ()=>{ if(weekIndex>WEEK_MIN){ weekIndex--; await fetchWeek(); }});
    document.getElementById('nextWeek').addEventListener('click', async ()=>{ if(weekIndex<WEEK_MAX){ weekIndex++; await fetchWeek(); }});
    document.getElementById('confirmBtn').addEventListener('click', async ()=>{
      if(!selectedIso) return;
      try{
        const res = await fetch(`${API_BASE}/book`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ action:'book', startIso:selectedIso, name:displayName, lineUserId })
        });
        const j = await res.json();
        if(j.ok){
          toast('予約を受け付けました。LINEにも確認メッセージを送ります。');
          // そのマスだけ×に変更
          weekSlots = weekSlots.filter(s=>s.startIso!==selectedIso);
          renderGrid();
          if(liff.isInClient && liff.isInClient()) setTimeout(()=> liff.closeWindow(), 300);
        }else{
          toast('その枠は埋まっています。別の時間をお選びください。');
          await fetchWeek();
        }
      }catch(e){ console.error(e); toast('通信エラー。時間をおいて再度お試しください。'); }
    });

    // 初期（今週）
    fetchWeek().catch(e=>{ console.error(e); toast('空き枠の取得に失敗しました。'); });

    // LIFFは遅延初期化（描画後）
    (async () => {
      try{
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const prof = await liff.getProfile();
        displayName = prof.displayName || '';
        lineUserId  = prof.userId || null;
        document.getElementById('name').value = displayName;
      }catch(e){ console.warn('LIFF init failed:', e); }
    })();
  })();
  </script>
</body>
</html>