<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>無料相談の予約（LINE限定）</title>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;background:#fafafa;color:#111;line-height:1.8}
    .wrap{min-height:100%;display:grid;place-items:start center;padding:24px}
    .card{width:100%;max-width:560px;background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:28px 24px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    h1{margin:0 0 14px;font-weight:800;font-size:clamp(26px,6vw,36px)}
    .help{font-size:13px;color:#666;margin:0 0 18px}

    label{display:block;margin:18px 0 6px;font-weight:600}
    .field{width:100%;padding:14px;border:1px solid #d1d5db;border-radius:10px;font-size:16px;background:#fff}
    .field:focus{outline:none;border-color:#60a5fa;box-shadow:0 0 0 3px rgba(59,130,246,.2)}

    .weekbar{display:flex;align-items:center;justify-content:space-between;margin:10px 0 4px}
    .weekbtn{border:1px solid #e5e7eb;background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
    .weektitle{font-weight:700}
    .dayhdr{margin:14px 0 6px;color:#444;font-size:14px}

    .slot{display:block;width:100%;padding:14px 16px;margin:8px 0;border:1px solid #e5e7eb;border-radius:12px;background:#fff;
          text-align:left;font-size:16px;cursor:pointer;transition:transform .02s ease, box-shadow .2s ease, border-color .2s}
    .slot:hover{box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .slot:active{transform:translateY(1px)}
    .slot:focus{outline:none;border-color:#60a5fa;box-shadow:0 0 0 3px rgba(59,130,246,.2)}
    .slot.selected{border-color:#1a2e44; box-shadow:0 0 0 3px rgba(26,46,68,.15)}

    .confirmbar{margin-top:16px}
    #confirmBtn{width:100%; padding:14px; border:none; border-radius:10px; background:#1a2e44; color:#fff;
      font-size:16px; font-weight:800; cursor:pointer}
    #confirmBtn[disabled]{opacity:.55; cursor:not-allowed}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>無料相談の予約</h1>
      <p class="help">LINEの表示名は自動入力されます。<strong>日付/時間を選ぶ → 「この日時で予約」</strong>の2ステップです。</p>

      <div class="section">
        <label>お名前</label>
        <input id="name" type="text" class="field" readonly />
      </div>

      <div class="weekbar">
        <button id="prevWeek" class="weekbtn" type="button" aria-label="前の週">← 前の週</button>
        <div id="weekTitle" class="weektitle" aria-live="polite"></div>
        <button id="nextWeek" class="weekbtn" type="button" aria-label="次の週">次の週 →</button>
      </div>

      <div id="slots" class="section"><!-- スロットが入る --></div>

      <div class="confirmbar">
        <button id="confirmBtn" type="button" disabled>この日時で予約</button>
      </div>

      <p id="toast" class="help" aria-live="polite"></p>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
  (function(){
    // === 設定（置換） ===
    const LIFF_ID  = "2007979122-nWPjgJGA"; // 例: 2007979122-nWPjgJGA
    const API_BASE = `${location.origin}/api`; // Cloudflare Pages Functions 経由

    // === 状態 ===
    let displayName = "";
    let lineUserId  = null;
    let allSlots = [];
    let weekIndex = 0;            // 0=今週, +1=次週...
    let selectedStartIso = null;  // 選択中の枠

    // === ユーティリティ ===
    function startOfWeek(d){ const x=new Date(d.getFullYear(),d.getMonth(),d.getDate()); x.setDate(x.getDate()-x.getDay()); x.setHours(0,0,0,0); return x; }
    function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function fmtMD(d){ return `${d.getMonth()+1}/${String(d.getDate()).padStart(2,'0')}`; }
    function wdayJP(dow){ return ['日','月','火','水','木','金','土'][dow]; }
    function fmtHM(d){ return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
    function prettyLabel(iso, minutes){ const d=new Date(iso); return `${fmtMD(d)}（${wdayJP(d.getDay())}） ${fmtHM(d)}〜（${minutes}分）`; }

    function setWeekTitle(baseDate){
      const ws = startOfWeek(baseDate), we = addDays(ws,6);
      document.getElementById("weekTitle").textContent =
        `${fmtMD(ws)}（${wdayJP(ws.getDay())}） 〜 ${fmtMD(we)}（${wdayJP(we.getDay())}）`;
    }

    function filterSlotsForWeek(all, baseDate){
      const ws = startOfWeek(baseDate), next = addDays(ws,7);
      return all.filter(s => {
        const t = new Date(s.startIso);
        return t >= ws && t < next;
      });
    }

    function selectSlot(btn){
      document.querySelectorAll(".slot.selected").forEach(el=>el.classList.remove("selected"));
      btn.classList.add("selected");
      selectedStartIso = btn.dataset.iso || null;
      updateConfirmBtn();
    }

    function updateConfirmBtn(){
      const confirmBtn = document.getElementById("confirmBtn");
      confirmBtn.disabled = !selectedStartIso;
    }

    function toast(t){ const el=document.getElementById("toast"); el.textContent=t||""; }

    // === 週レンダリング ===
    function renderWeek(){
      const base = addDays(new Date(), weekIndex*7);
      setWeekTitle(base);
      const slots = filterSlotsForWeek(allSlots, base);

      const wrap = document.getElementById("slots");
      wrap.innerHTML = "";
      selectedStartIso = null; updateConfirmBtn();

      if (slots.length === 0) {
        wrap.insertAdjacentHTML('beforeend', `<div class="help">この週の空きはありません。</div>`);
        return;
      }

      const byDay = {};
      slots.forEach(s => {
        const d = new Date(s.startIso);
        const key = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
        (byDay[key] ||= []).push(s);
      });

      Object.keys(byDay).sort((a,b)=> new Date(a)-new Date(b)).forEach(dayKey=>{
        const d = new Date(dayKey);
        wrap.insertAdjacentHTML('beforeend',
          `<div class="dayhdr">${fmtMD(d)}（${wdayJP(d.getDay())}）</div>`);

        byDay[dayKey]
          .sort((a,b)=> new Date(a.startIso) - new Date(b.startIso))
          .forEach(slot=>{
            const btn = document.createElement("button");
            btn.className = "slot";
            btn.type = "button";
            btn.dataset.iso = slot.startIso;
            btn.textContent = prettyLabel(slot.startIso, 30); // 30分表示
            btn.addEventListener("click", () => selectSlot(btn));
            wrap.appendChild(btn);
          });
      });
    }

    // === 初回取得 ===
    async function fetchAvailable() {
      const res = await fetch(`${API_BASE}/available`, { headers:{accept:"application/json"} });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      allSlots = data.slots || [];
      renderWeek();
    }

    // === 予約POST ===
    async function book(startIso) {
      try{
        const res = await fetch(`${API_BASE}/book`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action:"book", startIso, name: displayName, lineUserId })
        });
        const json = await res.json();
        if (json.ok) {
          toast("予約を受け付けました。LINEにも確認メッセージを送ります。");
          if (liff.isInClient && liff.isInClient()) setTimeout(()=> liff.closeWindow(), 300);
        } else {
          toast("その枠は埋まっています。別の時間をお選びください。");
        }
      } catch (e) {
        console.error(e);
        toast("通信エラー。時間をおいて再度お試しください。");
      }
    }

    // === イベント ===
    document.addEventListener("click", (e)=> {
      if (e.target.id === "prevWeek") { weekIndex--; renderWeek(); }
      if (e.target.id === "nextWeek") { weekIndex++; renderWeek(); }
      if (e.target.id === "confirmBtn" && selectedStartIso) { book(selectedStartIso); }
    });

    // === LIFF 初期化 ===
    (async () => {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const prof = await liff.getProfile();
        displayName = prof.displayName || "";
        lineUserId  = prof.userId || null;
        document.getElementById("name").value = displayName;
        await fetchAvailable();
      } catch (e) {
        console.error("LIFF init error:", e);
        toast("LIFFの初期化に失敗しました。LINEから再度お試しください。");
      }
    })();
  })();
  </script>
</body>
</html>