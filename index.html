<!-- index.html（バリデーション＆説明/常時押せるボタン/選択で赤枠解除） -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>無料相談の予約（LINE限定）</title>
  <style>
    :root{
      --brand:#1a2e44;
      --grid-border:#e5e7eb;
      --muted:#667085;
      --sat-bg:#eef5ff; --sun-bg:#ffeef0;
      --sat-fg:#2563eb; --sun-fg:#ef4444;
      --error:#ef4444;
    }
    *,*::before,*::after{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;background:#fafafa;color:#111}
    .wrap{max-width:860px;margin:0 auto;padding:12px}
    .card{background:#fff;border:1px solid var(--grid-border);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.05);overflow:hidden}

    /* 週バー */
    .weekbar{display:flex;align-items:center;justify-content:space-between;background:var(--brand);color:#fff;padding:10px 12px}
    .weekbtn{appearance:none;background:transparent;border:0;color:#fff;font-size:22px;cursor:pointer}
    .weekbtn[disabled]{opacity:.45;cursor:not-allowed}
    .range{font-weight:800;font-size:clamp(17px,4.5vw,21px)}

    .inner{padding:14px 14px 16px}
    label{font-size:13px;font-weight:700;display:inline-flex;align-items:center;gap:6px}
    .req{color:#ef4444;font-weight:900}
    .help{font-size:12px;color:var(--muted);margin:6px 0 12px}

    .name{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px;background:#fff;margin:6px 0 12px}
    .error{border-color:var(--error)!important; box-shadow:0 0 0 2px rgba(239,68,68,.18)!important}

    .cal-wrap{margin-top:8px}
    .cal{border:1px solid var(--grid-border);border-radius:10px;overflow:hidden}
    .cal.error{border-color:var(--error)!important; box-shadow:0 0 0 2px rgba(239,68,68,.18)!important}

    .grid{display:grid;grid-template-columns:56px repeat(7, minmax(0,1fr))}
    .cell{border-right:1px solid #eee;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:center}

    .th{background:#f5f7fa;font-weight:700;padding:6px}
    .dow{font-size:12px}
    .date{font-size:13px}
    .sat .dow,.sat .date{color:var(--sat-fg)}
    .sun .dow,.sun .date{color:var(--sun-fg)}
    .satcol{background:var(--sat-bg)}
    .suncol{background:var(--sun-bg)}

    .timecell{background:#fafafa;font-size:12px;font-weight:700;padding:6px}

    /* ○ */
    .ok{position:relative;cursor:pointer;border:0;background:transparent;width:100%;height:44px;display:flex;align-items:center;justify-content:center}
    .ok .ring{width:24px;height:24px;border-radius:999px;border:3px solid var(--brand);background:transparent}
    .ok.selected .ring{background:var(--brand)}
    /* × */
    .ngbox{width:100%;height:44px;display:flex;align-items:center;justify-content:center;font-weight:900;color:#777}

    .confirm{margin-top:12px}
    #confirmBtn{width:100%;padding:12px;border:none;border-radius:10px;background:var(--brand);color:#fff;font-size:15px;font-weight:800;cursor:pointer}

    @media (max-width:480px){
      .grid{grid-template-columns:48px repeat(7, minmax(0,1fr))}
      .ok,.ngbox{height:40px}
      .ok .ring{width:22px;height:22px;border-width:3px}
      .timecell{font-size:11px}
      .date{font-size:12px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="weekbar">
        <button id="prevWeek" class="weekbtn" aria-label="前の週">‹</button>
        <div id="range" class="range">–</div>
        <button id="nextWeek" class="weekbtn" aria-label="次の週">›</button>
      </div>
      <div class="inner">
        <label for="name">お名前 <span class="req" aria-hidden="true">*</span></label>
        <input id="name" class="name" type="text" placeholder="お名前を入力" required />

        <p class="help">お名前を入力し、日付の<span style="font-weight:700">○</span>から希望の開始時刻を選んで「この日時で予約」を押してください。</p>

        <div class="cal-wrap">
          <div class="cal" id="calBox"><div id="grid" class="grid"></div></div>
        </div>

        <div class="confirm">
          <button id="confirmBtn" type="button">この日時で予約</button>
        </div>
        <p id="toast" class="help" aria-live="polite"></p>
      </div>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
  (function(){
    const LIFF_ID  = "2007979122-nWPjgJGA";
    const API_BASE = `${location.origin}/api`;
    const WEEK_MIN = 0, WEEK_MAX = 1; // 今週/来週のみ
    let weekIndex = 0;

    const TIMES=[]; for(let h=8; h<=21; h++){ TIMES.push(`${pad(h)}:00`); if(h!==21) TIMES.push(`${pad(h)}:30`); }

    let lineUserId=null, selectedIso=null, weekSlots=[];

    function pad(n){return (n<10?'0':'')+n}
    function wdayJP(d){return ['日','月','火','水','木','金','土'][d]}
    function startOfWeek(d){ const x=new Date(d.getFullYear(),d.getMonth(),d.getDate()); x.setDate(x.getDate()-x.getDay()); x.setHours(0,0,0,0); return x; }
    function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function fmtMD(d){ return `${d.getMonth()+1}/${pad(d.getDate())}` }
    function hm(d){ return `${pad(d.getHours())}:${pad(d.getMinutes())}` }
    function toast(t){ document.getElementById('toast').textContent = t || '' }
    function getName(){ return (document.getElementById('name').value || '').trim(); }
    function div(cls){ const d=document.createElement('div'); d.className=cls; return d; }

    function clearErrors(){ document.getElementById('name').classList.remove('error'); document.getElementById('calBox').classList.remove('error'); }

    function setWeekBar(){
      const base = addDays(new Date(), weekIndex*7);
      const ws = startOfWeek(base), we = addDays(ws,6);
      document.getElementById('range').textContent = `${pad(ws.getMonth()+1)}/${pad(ws.getDate())} 〜 ${pad(we.getMonth()+1)}/${pad(we.getDate())}`;
      document.getElementById('prevWeek').disabled = (weekIndex<=WEEK_MIN);
      document.getElementById('nextWeek').disabled = (weekIndex>=WEEK_MAX);
    }

    function render(){
      const grid = document.getElementById('grid'); grid.innerHTML='';
      const rangeStart = new Date(); rangeStart.setHours(0,0,0,0);
      const rangeEnd = new Date(rangeStart); rangeEnd.setDate(rangeEnd.getDate()+14);

      const base = addDays(new Date(), weekIndex*7);
      const ws = startOfWeek(base);

      const days=[]; for(let i=0;i<7;i++){ const d=addDays(ws,i); if(d>=rangeStart && d<rangeEnd) days.push(d); }
      grid.style.gridTemplateColumns = `56px repeat(${days.length}, minmax(0,1fr))`;

      // header: 曜日
      grid.appendChild(div('cell th'));
      days.forEach(d=>{
        const cls = ['cell','th', d.getDay()==0?'sun':d.getDay()==6?'sat':''].join(' ').trim();
        const c = div(cls); c.innerHTML = `<div class="dow">${wdayJP(d.getDay())}</div>`; grid.appendChild(c);
      });
      // header: 日付
      grid.appendChild(div('cell th'));
      days.forEach(d=>{
        const cls = ['cell','th', d.getDay()==0?'sun':d.getDay()==6?'sat':''].join(' ').trim();
        const c = div(cls); c.innerHTML = `<div class="date">${fmtMD(d)}</div>`; grid.appendChild(c);
      });

      // slotMap
      const slotMap = new Map();
      weekSlots.forEach(s=>{ const dt=new Date(s.startIso); slotMap.set(`${dt.getFullYear()}-${dt.getMonth()+1}-${dt.getDate()}|${hm(dt)}`, s.startIso); });

      const now = new Date(); now.setSeconds(0,0);

      // body
      TIMES.forEach(time=>{
        const t = div('cell timecell'); t.textContent=time; grid.appendChild(t);
        days.forEach(d=>{
          const key = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}|${time}`;
          const iso = slotMap.get(key);
          const tone = d.getDay()==0?'suncol': d.getDay()==6?'satcol':'';
          const cell = div(`cell ${tone}`);

          if(iso){
            const isPast = new Date(iso) < now;
            if(isPast){
              const ng=div('ngbox'); ng.textContent='×'; cell.appendChild(ng);
            }else{
              const btn = document.createElement('button');
              btn.className='ok'; btn.type='button'; btn.dataset.iso=iso;
              const ring = document.createElement('span'); ring.className='ring'; btn.appendChild(ring);
              btn.addEventListener('click', ()=>{
                document.querySelectorAll('.ok.selected').forEach(el=>el.classList.remove('selected'));
                btn.classList.add('selected'); selectedIso = iso;
                // カレンダーのエラーは解除
                document.getElementById('calBox').classList.remove('error');
              });
              cell.appendChild(btn);
            }
          }else{
            const ng=div('ngbox'); ng.textContent='×'; cell.appendChild(ng);
          }
          grid.appendChild(cell);
        });
      });
    }

    async function fetchWeek(){
      setWeekBar();
      const res = await fetch(`${API_BASE}/available?week=${weekIndex}`, { headers:{accept:'application/json'} });
      const j = await res.json(); weekSlots = j.slots || []; render();
    }

    // イベント
    document.getElementById('prevWeek').addEventListener('click', async ()=>{ if(weekIndex>WEEK_MIN){ weekIndex--; await fetchWeek(); }});
    document.getElementById('nextWeek').addEventListener('click', async ()=>{ if(weekIndex<WEEK_MAX){ weekIndex++; await fetchWeek(); }});
    document.getElementById('name').addEventListener('input', ()=>{ if(getName()) document.getElementById('name').classList.remove('error'); });

    // 送信（常に押せる → ここでバリデーション）
    document.getElementById('confirmBtn').addEventListener('click', async ()=>{
      clearErrors();
      const name = getName();
      let bad = false;
      if(!name){ document.getElementById('name').classList.add('error'); bad = true; }
      if(!selectedIso){ document.getElementById('calBox').classList.add('error'); bad = true; }
      if(bad){ toast('お名前と日付（○）を選択してください。'); return; }

      try{
        const res = await fetch(`${API_BASE}/book`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ action:'book', startIso:selectedIso, name, lineUserId })
        });
        const j = await res.json();
        if(j.ok){
          toast("予約を受け付けました。LINEに確認メッセージを送ります。");
          weekSlots = weekSlots.filter(s=>s.startIso!==selectedIso);
          render();
          if(liff.isInClient && liff.isInClient()) setTimeout(()=> liff.closeWindow(), 600);
        }else{
          toast('その枠は埋まっています。別の時間をお選びください。');
          await fetchWeek();
        }
      }catch(e){ console.error(e); toast('通信エラー。時間をおいて再度お試しください。'); }
    });

    // 初期ロード
    fetchWeek().catch(e=> toast('空き枠の取得に失敗しました。'));

    // LIFF初期化：表示名を初期値（編集可）
    (async () => {
      try{
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const prof = await liff.getProfile();
        document.getElementById('name').value = prof.displayName || '';
      }catch(e){}
    })();
  })();
  </script>
</body>
</html>